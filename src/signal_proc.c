#include "signal_proc.h"
#include "procsetting.h"
#include "arm_common_tables.h"
#include "arm_const_structs.h"
#include "arm_math.h"
#include "diag/Trace.h"

/*-------------------- LOCAL CONSTANTS -----------------------------*/

static const float hannwindow[SIGNAL_SIZE] = { //hanning window coeff
	0,0,0.00001,0.00002,0.00004,0.00006,0.00008,0.00012,0.00015,0.00019,0.00024,0.00028,0.00034,0.0004,0.00046,0.00053,0.0006,0.00068,0.00076,0.00085,0.00094,0.00104,0.00114,0.00125,0.00136,0.00147,0.00159,0.00172,0.00185,0.00198,0.00212,0.00226,0.00241,0.00256,0.00272,0.00288,0.00305,0.00322,0.0034,0.00358,0.00376,0.00395,0.00415,0.00435,0.00455,0.00476,0.00498,0.00519,0.00542,0.00564,0.00588,0.00611,0.00636,0.0066,0.00685,0.00711,0.00737,0.00763,0.0079,0.00818,0.00846,0.00874,0.00903,0.00932,0.00962,0.00992,0.01023,0.01054,0.01085,0.01117,0.0115,0.01183,0.01216,0.0125,0.01284,0.01319,0.01354,0.0139,0.01426,0.01463,0.015,0.01537,0.01575,0.01614,0.01653,0.01692,0.01732,0.01772,0.01813,0.01854,0.01896,0.01938,0.0198,0.02023,0.02067,0.02111,0.02155,0.022,0.02245,0.02291,0.02337,0.02384,0.02431,0.02478,0.02526,0.02574,0.02623,0.02673,0.02722,0.02772,0.02823,0.02874,0.02926,0.02978,0.0303,0.03083,0.03136,0.0319,0.03244,0.03299,0.03354,0.03409,0.03465,0.03521,0.03578,0.03635,0.03693,0.03751,0.0381,0.03869,0.03928,0.03988,0.04048,0.04109,0.0417,0.04232,0.04294,0.04356,0.04419,0.04482,0.04546,0.0461,0.04675,0.0474,0.04805,0.04871,0.04937,0.05004,0.05071,0.05139,0.05207,0.05275,0.05344,0.05413,0.05483,0.05553,0.05623,0.05694,0.05766,0.05837,0.0591,0.05982,0.06055,0.06129,0.06202,0.06277,0.06351,0.06426,0.06502,0.06578,0.06654,0.06731,0.06808,0.06885,0.06963,0.07042,0.0712,0.07199,0.07279,0.07359,0.07439,0.0752,
	0.07601,0.07683,0.07765,0.07847,0.0793,0.08013,0.08096,0.0818,0.08265,0.08349,0.08435,0.0852,0.08606,0.08692,0.08779,0.08866,0.08953,0.09041,0.09129,0.09218,0.09307,0.09396,0.09486,0.09576,0.09667,0.09758,0.09849,0.09941,0.10033,0.10125,0.10218,0.10311,0.10404,0.10498,0.10593,0.10687,0.10782,0.10878,0.10973,0.1107,0.11166,0.11263,0.1136,0.11458,0.11556,0.11654,0.11753,0.11852,0.11951,0.12051,0.12151,0.12251,0.12352,0.12453,0.12555,0.12657,0.12759,0.12862,0.12965,0.13068,0.13171,0.13275,0.1338,0.13484,0.13589,0.13695,0.138,0.13907,0.14013,0.1412,0.14227,0.14334,0.14442,0.1455,0.14658,0.14767,0.14876,0.14985,0.15095,0.15205,0.15316,0.15426,0.15537,0.15649,0.1576,0.15872,0.15985,0.16097,0.1621,0.16324,0.16437,0.16551,0.16665,0.1678,0.16895,0.1701,0.17125,0.17241,0.17357,0.17474,0.1759,0.17707,0.17825,0.17942,0.1806,0.18178,0.18297,0.18416,0.18535,0.18654,0.18774,0.18894,0.19014,0.19135,0.19256,0.19377,0.19499,0.1962,0.19742,0.19865,0.19987,0.2011,0.20233,0.20357,0.20481,0.20605,0.20729,0.20853,0.20978,0.21103,0.21229,0.21354,0.2148,0.21606,0.21733,0.2186,0.21987,0.22114,0.22241,0.22369,0.22497,0.22626,0.22754,0.22883,0.23012,0.23141,0.23271,0.23401,0.23531,0.23661,0.23792,0.23923,0.24054,0.24185,0.24316,0.24448,0.2458,0.24713,0.24845,0.24978,0.25111,0.25244,0.25378,0.25511,0.25645,0.25779,0.25914,0.26048,0.26183,0.26318,0.26453,0.26589,0.26725,0.26861,0.26997,0.27133,0.2727,0.27407,0.27544,0.27681,
	0.27818,0.27956,0.28094,0.28232,0.2837,0.28509,0.28647,0.28786,0.28925,0.29064,0.29204,0.29344,0.29483,0.29623,0.29764,0.29904,0.30045,0.30186,0.30327,0.30468,0.30609,0.30751,0.30892,0.31034,0.31176,0.31319,0.31461,0.31604,0.31747,0.3189,0.32033,0.32176,0.32319,0.32463,0.32607,0.32751,0.32895,0.33039,0.33184,0.33328,0.33473,0.33618,0.33763,0.33908,0.34054,0.34199,0.34345,0.34491,0.34637,0.34783,0.34929,0.35076,0.35222,0.35369,0.35516,0.35663,0.3581,0.35957,0.36104,0.36252,0.36399,0.36547,0.36695,0.36843,0.36991,0.37139,0.37288,0.37436,0.37585,0.37734,0.37882,0.38031,0.3818,0.3833,0.38479,0.38628,0.38778,0.38927,0.39077,0.39227,0.39377,0.39527,0.39677,0.39827,0.39978,0.40128,0.40278,0.40429,0.4058,0.4073,0.40881,0.41032,0.41183,0.41334,0.41486,0.41637,0.41788,0.4194,0.42091,0.42243,0.42394,0.42546,0.42698,0.4285,0.43002,0.43154,0.43306,0.43458,0.4361,0.43762,0.43915,0.44067,0.44219,0.44372,0.44524,0.44677,0.4483,0.44982,0.45135,0.45288,0.45441,0.45593,0.45746,0.45899,0.46052,0.46205,0.46358,0.46511,0.46664,0.46818,0.46971,0.47124,0.47277,0.4743,0.47584,0.47737,0.4789,0.48044,0.48197,0.4835,0.48504,0.48657,0.48811,0.48964,0.49118,0.49271,0.49424,0.49578,0.49731,0.49885,0.50038,0.50192,0.50345,0.50499,0.50652,0.50806,0.50959,0.51113,0.51266,0.51419,0.51573,0.51726,0.5188,0.52033,0.52186,0.5234,0.52493,0.52646,0.52799,0.52953,0.53106,0.53259,0.53412,0.53565,0.53718,0.53871,0.54024,0.54177,0.5433,0.54483,0.54636,0.54789,0.54941,0.55094,0.55247,0.55399,0.55552,0.55704,0.55857,0.56009,0.56162,0.56314,0.56466,0.56618,0.5677,0.56922,0.57074,0.57226,0.57378,0.5753,0.57681,0.57833,0.57985,0.58136,0.58287,0.58439,0.5859,0.58741,0.58892,0.59043,0.59194,0.59345,0.59496,0.59646,0.59797,0.59947,0.60098,0.60248,0.60398,0.60548,0.60698,0.60848,0.60998,0.61147,0.61297,0.61446,0.61596,0.61745,0.61894,0.62043,0.62192,0.62341,0.62489,0.62638,0.62786,0.62935,0.63083,0.63231,0.63379,0.63527,0.63674,0.63822,0.63969,0.64117,0.64264,0.64411,0.64558,0.64705,0.64851,0.64998,0.65144,0.6529,0.65436,0.65582,0.65728,0.65874,0.66019,0.66164,0.66309,0.66454,0.66599,0.66744,0.66889,0.67033,0.67177,0.67321,0.67465,0.67609,0.67752,0.67896,0.68039,0.68182,0.68325,0.68468,0.6861,0.68752,0.68895,0.69037,0.69178,0.6932,0.69462,0.69603,0.69744,0.69885,0.70026,0.70166,0.70306,0.70447,0.70587,0.70726,0.70866,0.71005,0.71144,0.71283,0.71422,0.71561,0.71699,0.71837,0.71975,0.72113,0.72251,0.72388,0.72525,0.72662,0.72799,0.72935,0.73071,0.73207,0.73343,0.73479,0.73614,0.73749,0.73884,0.74019,0.74154,0.74288,0.74422,0.74556,0.74689,0.74823,0.74956,0.75089,0.75221,0.75354,0.75486,0.75618,0.75749,0.75881,0.76012,0.76143,0.76274,0.76404,0.76534,0.76664,0.76794,0.76923,0.77053,0.77182,0.7731,0.77439,0.77567,0.77695,
	0.77822,0.7795,0.78077,0.78204,0.7833,0.78457,0.78583,0.78708,0.78834,0.78959,0.79084,0.79209,0.79333,0.79458,0.79581,0.79705,0.79828,0.79951,0.80074,0.80197,0.80319,0.80441,0.80562,0.80684,0.80805,0.80925,0.81046,0.81166,0.81286,0.81405,0.81525,0.81644,0.81762,0.81881,0.81999,0.82117,0.82234,0.82351,0.82468,0.82585,0.82701,0.82817,0.82932,0.83048,0.83163,0.83277,0.83392,0.83506,0.8362,0.83733,0.83846,0.83959,0.84072,0.84184,0.84296,0.84407,0.84518,0.84629,0.8474,0.8485,0.8496,0.85069,0.85179,0.85287,0.85396,0.85504,0.85612,0.8572,0.85827,0.85934,0.8604,0.86147,0.86252,0.86358,0.86463,0.86568,0.86672,0.86777,0.8688,0.86984,0.87087,0.8719,0.87292,0.87394,0.87496,0.87597,0.87698,0.87799,0.87899,0.87999,0.88099,0.88198,0.88297,0.88395,0.88493,0.88591,0.88689,0.88786,0.88882,0.88979,0.89074,0.8917,0.89265,0.8936,0.89455,0.89549,0.89642,0.89736,0.89829,0.89921,0.90013,0.90105,0.90197,0.90288,0.90379,0.90469,0.90559,0.90648,0.90738,0.90826,0.90915,0.91003,0.9109,0.91178,0.91265,0.91351,0.91437,0.91523,0.91608,0.91693,0.91778,0.91862,0.91945,0.92029,0.92112,0.92194,0.92276,0.92358,0.92439,0.9252,0.92601,0.92681,0.92761,0.9284,0.92919,0.92998,0.93076,0.93153,0.93231,0.93308,0.93384,0.9346,0.93536,0.93611,0.93686,0.93761,0.93835,0.93908,0.93981,0.94054,0.94127,0.94199,0.9427,0.94341,0.94412,0.94482,0.94552,0.94622,0.94691,0.94759,0.94827,0.94895,0.94962,0.95029,0.95096,0.95162,0.95228,0.95293,0.95358,0.95422,0.95486,0.95549,0.95613,0.95675,0.95737,0.95799,0.95861,0.95921,0.95982,0.96042,0.96102,0.96161,0.9622,0.96278,0.96336,0.96393,0.9645,0.96507,0.96563,0.96619,0.96674,0.96729,0.96783,0.96837,0.96891,0.96944,0.96996,0.97048,0.971,0.97151,0.97202,0.97253,0.97303,0.97352,0.97401,0.9745,0.97498,0.97546,0.97593,0.9764,0.97686,0.97732,0.97778,0.97823,0.97867,0.97911,0.97955,0.97998,0.98041,0.98083,0.98125,0.98167,0.98207,0.98248,0.98288,0.98328,0.98367,0.98405,0.98444,0.98481,0.98519,0.98556,0.98592,0.98628,0.98663,0.98698,0.98733,0.98767,0.98801,0.98834,0.98867,0.98899,0.98931,0.98962,0.98993,0.99023,0.99053,0.99083,0.99112,0.9914,0.99168,0.99196,0.99223,0.9925,0.99276,0.99302,0.99327,0.99352,0.99377,0.99401,0.99424,0.99447,0.9947,0.99492,0.99513,0.99534,0.99555,0.99575,0.99595,0.99614,0.99633,0.99651,0.99669,0.99687,0.99703,0.9972,0.99736,0.99751,0.99766,
	0.99781,0.99795,0.99809,0.99822,0.99835,0.99847,0.99859,0.9987,0.99881,0.99891,0.99901,0.9991,0.99919,0.99928,0.99936,0.99943,0.9995,0.99957,0.99963,0.99969,0.99974,0.99979,0.99983,0.99987,0.9999,0.99993,0.99995,0.99997,0.99999,0.99999,1,1,0.99999,0.99999,0.99997,0.99995,0.99993,0.9999,0.99987,0.99983,0.99979,0.99974,0.99969,0.99963,0.99957,0.9995,0.99943,0.99936,0.99928,0.99919,0.9991,0.99901,0.99891,0.99881,0.9987,0.99859,0.99847,0.99835,0.99822,0.99809,0.99795,0.99781,0.99766,0.99751,0.99736,0.9972,0.99703,0.99687,0.99669,0.99651,0.99633,0.99614,0.99595,0.99575,0.99555,0.99534,0.99513,0.99492,0.9947,0.99447,0.99424,0.99401,0.99377,0.99352,0.99327,0.99302,0.99276,0.9925,0.99223,0.99196,0.99168,0.9914,0.99112,0.99083,0.99053,0.99023,0.98993,0.98962,0.98931,0.98899,0.98867,0.98834,0.98801,0.98767,0.98733,0.98698,0.98663,0.98628,0.98592,0.98556,0.98519,0.98481,0.98444,0.98405,0.98367,0.98328,0.98288,0.98248,0.98207,0.98167,0.98125,0.98083,0.98041,0.97998,0.97955,0.97911,0.97867,0.97823,0.97778,0.97732,0.97686,0.9764,0.97593,0.97546,0.97498,0.9745,0.97401,0.97352,0.97303,0.97253,0.97202,0.97151,0.971,0.97048,0.96996,0.96944,0.96891,0.96837,0.96783,0.96729,0.96674,0.96619,0.96563,0.96507,0.9645,0.96393,0.96336,0.96278,0.9622,0.96161,0.96102,0.96042,0.95982,0.95921,0.95861,0.95799,0.95737,0.95675,0.95613,0.95549,0.95486,0.95422,0.95358,0.95293,0.95228,0.95162,0.95096,0.95029,0.94962,0.94895,0.94827,0.94759,0.94691,0.94622,0.94552,0.94482,0.94412,0.94341,0.9427,0.94199,0.94127,0.94054,0.93981,0.93908,0.93835,0.93761,0.93686,0.93611,0.93536,0.9346,0.93384,0.93308,0.93231,0.93153,0.93076,0.92998,0.92919,0.9284,0.92761,0.92681,0.92601,0.9252,0.92439,0.92358,0.92276,0.92194,0.92112,0.92029,0.91945,0.91862,0.91778,0.91693,0.91608,0.91523,0.91437,0.91351,0.91265,0.91178,0.9109,0.91003,0.90915,0.90826,0.90738,0.90648,0.90559,0.90469,0.90379,0.90288,0.90197,0.90105,0.90013,0.89921,0.89829,0.89736,0.89642,0.89549,0.89455,0.8936,0.89265,0.8917,0.89074,0.88979,0.88882,0.88786,
	0.88689,0.88591,0.88493,0.88395,0.88297,0.88198,0.88099,0.87999,0.87899,0.87799,0.87698,0.87597,0.87496,0.87394,0.87292,0.8719,0.87087,0.86984,0.8688,0.86777,0.86672,0.86568,0.86463,0.86358,0.86252,0.86147,0.8604,0.85934,0.85827,0.8572,0.85612,0.85504,0.85396,0.85287,0.85179,0.85069,0.8496,0.8485,0.8474,0.84629,0.84518,0.84407,0.84296,0.84184,0.84072,0.83959,0.83846,0.83733,0.8362,0.83506,0.83392,0.83277,0.83163,0.83048,0.82932,0.82817,0.82701,0.82585,0.82468,0.82351,0.82234,0.82117,0.81999,0.81881,0.81762,0.81644,0.81525,0.81405,0.81286,0.81166,0.81046,0.80925,0.80805,0.80684,0.80562,0.80441,0.80319,0.80197,0.80074,0.79951,0.79828,0.79705,0.79581,0.79458,0.79333,0.79209,0.79084,0.78959,0.78834,0.78708,0.78583,0.78457,0.7833,0.78204,0.78077,0.7795,0.77822,0.77695,0.77567,0.77439,0.7731,0.77182,0.77053,0.76923,0.76794,0.76664,0.76534,0.76404,0.76274,0.76143,0.76012,0.75881,0.75749,0.75618,0.75486,0.75354,0.75221,0.75089,0.74956,0.74823,0.74689,0.74556,0.74422,0.74288,0.74154,0.74019,0.73884,0.73749,0.73614,0.73479,0.73343,0.73207,0.73071,0.72935,0.72799,0.72662,0.72525,0.72388,0.72251,0.72113,0.71975,0.71837,0.71699,0.71561,0.71422,0.71283,0.71144,0.71005,0.70866,0.70726,0.70587,0.70447,0.70306,0.70166,0.70026,0.69885,0.69744,0.69603,0.69462,0.6932,0.69178,0.69037,0.68895,0.68752,0.6861,0.68468,0.68325,0.68182,0.68039,0.67896,0.67752,0.67609,0.67465,0.67321,0.67177,0.67033,0.66889,0.66744,0.66599,0.66454,0.66309,0.66164,0.66019,0.65874,0.65728,0.65582,0.65436,0.6529,0.65144,0.64998,0.64851,0.64705,0.64558,0.64411,0.64264,0.64117,0.63969,0.63822,0.63674,0.63527,0.63379,0.63231,0.63083,0.62935,0.62786,0.62638,0.62489,0.62341,0.62192,0.62043,0.61894,0.61745,0.61596,0.61446,0.61297,0.61147,0.60998,0.60848,0.60698,0.60548,0.60398,0.60248,0.60098,0.59947,0.59797,0.59646,0.59496,0.59345,0.59194,0.59043,0.58892,0.58741,0.5859,0.58439,0.58287,0.58136,0.57985,0.57833,0.57681,0.5753,0.57378,0.57226,0.57074,0.56922,0.5677,0.56618,0.56466,0.56314,0.56162,0.56009,0.55857,0.55704,0.55552,0.55399,0.55247,0.55094,0.54941,0.54789,0.54636,0.54483,0.5433,0.54177,0.54024,0.53871,0.53718,0.53565,0.53412,0.53259,0.53106,0.52953,0.52799,0.52646,0.52493,0.5234,0.52186,0.52033,0.5188,0.51726,0.51573,0.51419,0.51266,0.51113,0.50959,0.50806,0.50652,0.50499,0.50345,0.50192,0.50038,0.49885,0.49731,0.49578,0.49424,0.49271,0.49118,0.48964,0.48811,0.48657,0.48504,0.4835,0.48197,0.48044,0.4789,0.47737,0.47584,0.4743,0.47277,0.47124,0.46971,0.46818,0.46664,0.46511,0.46358,0.46205,0.46052,0.45899,0.45746,0.45593,0.45441,0.45288,0.45135,0.44982,0.4483,0.44677,
	0.44524,0.44372,0.44219,0.44067,0.43915,0.43762,0.4361,0.43458,0.43306,0.43154,0.43002,0.4285,0.42698,0.42546,0.42394,0.42243,0.42091,0.4194,0.41788,0.41637,0.41486,0.41334,0.41183,0.41032,0.40881,0.4073,0.4058,0.40429,0.40278,0.40128,0.39978,0.39827,0.39677,0.39527,0.39377,0.39227,0.39077,0.38927,0.38778,0.38628,0.38479,0.3833,0.3818,0.38031,0.37882,0.37734,0.37585,0.37436,0.37288,0.37139,0.36991,0.36843,0.36695,0.36547,0.36399,0.36252,0.36104,0.35957,0.3581,0.35663,0.35516,0.35369,0.35222,0.35076,0.34929,0.34783,0.34637,0.34491,0.34345,0.34199,0.34054,0.33908,0.33763,0.33618,0.33473,0.33328,0.33184,0.33039,0.32895,0.32751,0.32607,0.32463,0.32319,0.32176,0.32033,0.3189,0.31747,0.31604,0.31461,0.31319,0.31176,0.31034,0.30892,0.30751,0.30609,0.30468,0.30327,0.30186,0.30045,0.29904,0.29764,0.29623,0.29483,0.29344,0.29204,0.29064,0.28925,0.28786,0.28647,0.28509,0.2837,0.28232,0.28094,0.27956,0.27818,0.27681,0.27544,0.27407,0.2727,0.27133,0.26997,0.26861,0.26725,0.26589,0.26453,0.26318,0.26183,0.26048,0.25914,0.25779,0.25645,0.25511,0.25378,0.25244,0.25111,0.24978,0.24845,0.24713,0.2458,0.24448,0.24316,0.24185,0.24054,0.23923,0.23792,0.23661,0.23531,0.23401,0.23271,0.23141,0.23012,0.22883,0.22754,0.22626,0.22497,0.22369,0.22241,0.22114,0.21987,0.2186,0.21733,0.21606,0.2148,0.21354,0.21229,0.21103,0.20978,0.20853,0.20729,0.20605,0.20481,0.20357,0.20233,0.2011,0.19987,0.19865,0.19742,0.1962,0.19499,0.19377,0.19256,0.19135,0.19014,0.18894,0.18774,0.18654,0.18535,0.18416,0.18297,0.18178,0.1806,0.17942,0.17825,0.17707,0.1759,0.17474,0.17357,0.17241,0.17125,0.1701,0.16895,0.1678,0.16665,0.16551,0.16437,0.16324,0.1621,0.16097,0.15985,0.15872,0.1576,0.15649,0.15537,0.15426,0.15316,0.15205,0.15095,0.14985,0.14876,0.14767,0.14658,0.1455,0.14442,0.14334,0.14227,0.1412,0.14013,0.13907,0.138,0.13695,0.13589,0.13484,0.1338,0.13275,0.13171,0.13068,0.12965,0.12862,0.12759,0.12657,0.12555,0.12453,0.12352,0.12251,0.12151,0.12051,0.11951,0.11852,0.11753,0.11654,0.11556,0.11458,0.1136,0.11263,0.11166,0.1107,0.10973,0.10878,0.10782,0.10687,0.10593,0.10498,0.10404,0.10311,0.10218,0.10125,0.10033,0.09941,0.09849,0.09758,0.09667,
	0.09576,0.09486,0.09396,0.09307,0.09218,0.09129,0.09041,0.08953,0.08866,0.08779,0.08692,0.08606,0.0852,0.08435,0.08349,0.08265,0.0818,0.08096,0.08013,0.0793,0.07847,0.07765,0.07683,0.07601,0.0752,0.07439,0.07359,0.07279,0.07199,0.0712,0.07042,0.06963,0.06885,0.06808,0.06731,0.06654,0.06578,0.06502,0.06426,0.06351,0.06277,0.06202,0.06129,0.06055,0.05982,0.0591,0.05837,0.05766,0.05694,0.05623,0.05553,0.05483,0.05413,0.05344,0.05275,0.05207,0.05139,0.05071,0.05004,0.04937,0.04871,0.04805,0.0474,0.04675,0.0461,0.04546,0.04482,0.04419,0.04356,0.04294,0.04232,0.0417,0.04109,0.04048,0.03988,0.03928,0.03869,0.0381,0.03751,0.03693,0.03635,0.03578,0.03521,0.03465,0.03409,0.03354,0.03299,0.03244,0.0319,0.03136,0.03083,0.0303,0.02978,0.02926,0.02874,0.02823,0.02772,0.02722,0.02673,0.02623,0.02574,0.02526,0.02478,0.02431,0.02384,0.02337,0.02291,0.02245,0.022,0.02155,0.02111,0.02067,0.02023,0.0198,0.01938,0.01896,0.01854,0.01813,0.01772,0.01732,0.01692,0.01653,0.01614,0.01575,0.01537,0.015,0.01463,0.01426,0.0139,0.01354,0.01319,0.01284,0.0125,0.01216,0.01183,0.0115,0.01117,0.01085,0.01054,0.01023,0.00992,0.00962,0.00932,0.00903,0.00874,0.00846,0.00818,0.0079,0.00763,0.00737,0.00711,0.00685,0.0066,0.00636,0.00611,0.00588,0.00564,0.00542,0.00519,0.00498,0.00476,0.00455,0.00435,0.00415,0.00395,0.00376,0.00358,0.0034,0.00322,0.00305,0.00288,0.00272,0.00256,0.00241,0.00226,0.00212,0.00198,0.00185,0.00172,0.00159,0.00147,0.00136,0.00125,0.00114,0.00104,0.00094,0.00085,0.00076,0.00068,0.0006,0.00053,0.00046,0.0004,0.00034,0.00028,0.00024,0.00019,0.00015,0.00012,0.00008,0.00006,0.00004,0.00002,0.00001,0,0
};

static const float filcoeff[FIL_LEN][FIL_LEN] = { //sgolay filter coefficients
	{0.728,0.363,0.115,-0.033,-0.102,-0.11,-0.077,-0.022,0.036,0.077,0.082,0.033,-0.091},
	{0.363,0.275,0.198,0.132,0.077,0.033,0,-0.022,-0.033,-0.033,-0.022,0,0.033},
	{0.115,0.198,0.23,0.222,0.184,0.128,0.063,0,-0.05,-0.078,-0.072,-0.022,0.082},
	{-0.033,0.132,0.222,0.251,0.233,0.182,0.112,0.037,-0.029,-0.072,-0.078,-0.033,0.077},
	{-0.102,0.077,0.184,0.233,0.235,0.202,0.147,0.082,0.019,-0.029,-0.05,-0.033,0.036},
	{-0.11,0.033,0.128,0.182,0.202,0.195,0.168,0.128,0.082,0.037,0,-0.022,-0.022},
	{-0.077,0,0.063,0.112,0.147,0.168,0.175,0.168,0.147,0.112,0.063,0,-0.077},
	{-0.022,-0.022,0,0.037,0.082,0.128,0.168,0.195,0.202,0.182,0.128,0.033,-0.11},
	{0.036,-0.033,-0.05,-0.029,0.019,0.082,0.147,0.202,0.235,0.233,0.184,0.077,-0.102},
	{0.077,-0.033,-0.078,-0.072,-0.029,0.037,0.112,0.182,0.233,0.251,0.222,0.132,-0.033},
	{0.082,-0.022,-0.072,-0.078,-0.05,0,0.063,0.128,0.184,0.222,0.23,0.198,0.115},
	{0.033,0,-0.022,-0.033,-0.033,-0.022,0,0.033,0.077,0.132,0.198,0.275,0.363},
	{-0.091,0.033,0.082,0.077,0.036,-0.022,-0.077,-0.11,-0.102,-0.033,0.115,0.363,0.728}
};

/*------------------------- FUNCTIONS -----------------------------*/

/* calculate auto psd */
void psd_calc(float* fft_data, float* psd_data){
	//perform bin-bin complex conjugate multiplication
	uint16_t k = 0;
	for(uint16_t i=0; i<NFFT; i+=2){
		psd_data[k] = psd_data[k] + 20*log10(2*(fft_data[i]*fft_data[i] + fft_data[i+1]*fft_data[i+1])/F_SAMPLING/SUM_WINDOW/PSD_NWINDOW);
		k++;
	}
}

/* calculate FFT, the result will be arranged into
 * {real(1), imag(1), real(2), imag(2),..,real(n), imag(n)}a */
void fft_calc(float* signal_data, float* fft_data){
	arm_status status;
	float signal_mean = mean_calc(signal_data);
	arm_rfft_fast_instance_f32 fftset;

	//init fft
	status = arm_rfft_fast_init_f32(&fftset, NFFT);

	//perform windowing
	for(uint16_t i = 0 ; i<SIGNAL_SIZE; i++){
		signal_data[i] = (signal_data[i] - signal_mean)*hannwindow[i];
	}

	//perform fft if init succesful
	if(status == ARM_MATH_SUCCESS){
		arm_rfft_fast_f32(&fftset, signal_data, fft_data,0);
	}
}

/* perform smoothing & peak selection */
void peak_sel(float* psd_data){
	//smooth the psd
	smooth(psd_data, NFFT/2);
}


/*smooth the input using savitzky-golay*/
void smooth(float* input, uint16_t input_len){
	uint16_t sindex = 0;
	float tempholder[input_len];
	float tempsum = 0;

	//calculate the beginning section of data
	for(uint16_t filrow = (FIL_LEN - 1); filrow >= (FIL_LEN+1)/2; filrow--){
		tempsum = 0;
		uint16_t filcol =0;
		for(int16_t k = (FIL_LEN - 1); k >= 0 ; k--){
			tempsum = tempsum + filcoeff[filrow][filcol]*input[k];
			filcol++;
		}
		tempholder[sindex] = tempsum;
		sindex++;
	}

	//calculate the active/central section of data
	sindex = (FIL_LEN+1)/2 - 1;
	for(uint16_t i = 0 ; i < (input_len - FIL_LEN); i++){
		tempsum = 0;
		//apply sliding window calculation
		for(uint16_t k = 0; k < FIL_LEN; k++){
			tempsum = tempsum + input[i + k] * filcoeff[(FIL_LEN+1)/2][k];
		}
		//calculate final value
		tempholder[sindex] = tempsum;
		sindex++;
	}

	//calculate the end section of data
	sindex = input_len - (FIL_LEN+1)/2;
	for(int16_t filrow = (FIL_LEN-1)/2 ; filrow >= 0; filrow--){
		tempsum = 0;
		uint16_t filcol = 0;
		for(uint16_t k = input_len - 1; k >= (input_len - FIL_LEN) ; k--){
			tempsum = tempsum + filcoeff[filrow][filcol]*input[k];
			filcol++;
		}
		tempholder[sindex] = tempsum;
		sindex++;
	}

	memcpy(input, tempholder,input_len*sizeof(float));
}

/* perform fft data selection
 * based on natural frequencyinformation
 */
void fft_sel(float* fft_data){

}

/* calculate the mean of signal */
float mean_calc(float* signal_data){
	float meanval = 0;
	for(uint16_t i = 0 ; i<SIGNAL_SIZE; i++){
		meanval += signal_data[i];
	}

	return (meanval/SIGNAL_SIZE);
}
